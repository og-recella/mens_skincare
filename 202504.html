<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>特定事業セグメント詳細分析 インフォグラフィック</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #F7FFF7; 
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 700px; 
            margin-left: auto;
            margin-right: auto;
            height: 320px; 
        }
        @media (min-width: 768px) { 
            .chart-container {
                height: 400px; 
            }
        }
        .stat-card {
            background-color: white;
            border-radius: 0.5rem; 
            padding: 1.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
            margin-bottom: 1.5rem; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .kpi-value {
            font-size: 2.0rem; 
            font-weight: 700; 
            color: #FF6B6B; 
        }
        .kpi-label {
            font-size: 0.875rem; 
            color: #1A535C; 
            margin-top: 0.25rem; 
        }
        .kpi-change {
            font-size: 0.875rem; 
            font-weight: 600; 
            margin-top: 0.25rem; 
        }
        .positive-change {
            color: #28a745; 
        }
        .negative-change {
            color: #dc3545; 
        }
        h1, h2, h3, h4 {
            color: #1A535C; 
        }
        .section-title {
            font-size: 1.875rem; 
            font-weight: 700; 
            margin-bottom: 1rem; 
            padding-bottom: 0.5rem; 
            border-bottom: 2px solid #4ECDC4; 
        }
    </style>
    <!-- 
        Chosen Color Palette: "Energetic & Playful" (Conceptual - actual hex codes defined in <style>)
        Primary: #FF6B6B (Vibrant Red/Coral)
        Secondary: #4ECDC4 (Teal)
        Accent: #45B7D1 (Sky Blue)
        Neutral/Background: #F7FFF7 (Very Light Green/Off-white)
        Text: #1A535C (Dark Teal/Almost Black)

        Confirmation: Neither Mermaid JS nor SVG graphics were used in this infographic.
        All charts are rendered using Chart.js on Canvas.
    -->
</head>
<body class="text-gray-800">

    <header class="bg-[#1A535C] text-white py-8 shadow-lg">
        <div class="container mx-auto px-6 text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-[#4ECDC4]">特定事業セグメント パフォーマンスインサイト</h1>
            <p class="mt-4 text-lg md:text-xl text-gray-300">Eコマース事業の直近6ヶ月トレンド分析 (ディープリサーチレポートより)</p>
        </div>
    </header>

    <main class="container mx-auto px-4 md:px-6 py-8">

        <section id="introduction" class="mb-12 stat-card">
            <h2 class="text-2xl font-semibold mb-4 text-[#1A535C]">はじめに：本レポートの目的と概要</h2>
            <p class="text-gray-700 leading-relaxed">
                本インフォグラフィックは、特定のEコマース事業セグメントにおける過去6ヶ月間の主要業績評価指標（KPI）の動向を視覚的に分析し、その結果から得られるインサイトを提供することを目的としています。市場全体のトレンドを直接示すものではありませんが、この事業セグメントのパフォーマンス変動を通じて、ミクロな市場環境の変化や施策効果の一端を垣間見ることができます。データに基づいた現状理解を深め、今後の戦略立案に資する情報を提供します。
            </p>
        </section>

        <section id="overview" class="mb-12">
            <h3 class="section-title">主要指標サマリー（2025年04月）</h3>
            <p class="text-gray-600 mb-6">最新月の主要KPIとその前月からの変動を示します。事業の現在のスナップショットを把握できます。</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="stat-card text-center">
                    <div>
                        <p class="kpi-value" id="latestSales">758.5<span class="text-base">万円</span></p>
                        <p class="kpi-label">当月売上高</p>
                    </div>
                    <p class="kpi-change" id="salesMoMChange"></p>
                </div>
                <div class="stat-card text-center">
                    <div>
                        <p class="kpi-value" id="latestCustomers">1,333<span class="text-base">人</span></p>
                        <p class="kpi-label">当月顧客数</p>
                    </div>
                    <p class="kpi-change" id="customersMoMChange"></p>
                </div>
                <div class="stat-card text-center">
                    <div>
                        <p class="kpi-value" id="latestNetGrossProfitMargin">0.0<span class="text-base">%</span></p>
                        <p class="kpi-label">当月純粗利益率</p>
                    </div>
                    <p class="kpi-change" id="netGrossProfitMarginMoMChange"></p>
                </div>
                <div class="stat-card text-center">
                    <div>
                        <p class="kpi-value" id="latestAdCostRatio">21.1<span class="text-base">%</span></p>
                        <p class="kpi-label">広告費比率</p>
                    </div>
                    <p class="kpi-change" id="adCostRatioMoMChange"></p>
                </div>
                <div class="stat-card text-center">
                    <div>
                        <p class="kpi-value" id="latestROAS">4.74</p>
                        <p class="kpi-label">当月ROAS</p>
                    </div>
                    <p class="kpi-change" id="roasMoMChange"></p>
                </div>
                <div class="stat-card text-center">
                    <div>
                        <p class="kpi-value" id="latestCPA">3,636<span class="text-base">円</span></p>
                        <p class="kpi-label">当月CPA (新規)</p>
                    </div>
                    <p class="kpi-change" id="cpaMoMChange"></p>
                </div>
            </div>
        </section>

        <section id="salesPerformance" class="mb-12 stat-card">
            <h4 class="text-xl font-semibold mb-2 text-[#1A535C]">事業セグメント売上トレンド</h4>
            <p class="text-gray-600 mb-6 text-sm">月次の売上高（税抜）の推移です。このセグメントの成長性や季節変動、外部要因の影響などを考察する手がかりとなります。</p>
            <div class="chart-container">
                <canvas id="salesChart"></canvas>
            </div>
            <p class="mt-4 text-xs text-gray-500 text-center">グラフ: 月次売上高（税抜）推移</p>
        </section>

        <section id="customerMetrics" class="mb-12">
            <h3 class="section-title">顧客動向分析</h3>
            <p class="text-gray-600 mb-6">顧客数、注文件数、および顧客あたりの購買行動や単価の変動を分析し、顧客エンゲージメントの質と量を評価します。</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="stat-card">
                    <h4 class="text-lg font-semibold mb-2 text-[#1A535C]">月次顧客数</h4>
                    <p class="text-gray-600 mb-4 text-xs">当セグメントにおけるアクティブ顧客数の月次変動。市場へのリーチや集客施策の効果を示唆します。</p>
                    <div class="chart-container h-72 md:h-80">
                        <canvas id="customersChart"></canvas>
                    </div>
                    <p class="mt-2 text-xs text-gray-500 text-center">グラフ: 月次顧客数推移</p>
                </div>
                <div class="stat-card">
                    <h4 class="text-lg font-semibold mb-2 text-[#1A535C]">月次注文件数</h4>
                    <p class="text-gray-600 mb-4 text-xs">月ごとの総注文件数の変動。顧客数と顧客あたりの購入頻度の両方に影響されます。</p>
                    <div class="chart-container h-72 md:h-80">
                        <canvas id="ordersChart"></canvas>
                    </div>
                     <p class="mt-2 text-xs text-gray-500 text-center">グラフ: 月次注文件数推移</p>
                </div>
                <div class="stat-card">
                    <h4 class="text-lg font-semibold mb-2 text-[#1A535C]">既存顧客と新規顧客の推移</h4>
                    <p class="text-gray-600 mb-4 text-xs">月ごとの既存顧客数と新規顧客数の変動を示します。顧客基盤の成長と新規獲得のバランスを把握できます。</p>
                    <div class="chart-container h-72 md:h-80">
                        <canvas id="customerCompositionChart"></canvas>
                    </div>
                     <p class="mt-2 text-xs text-gray-500 text-center">グラフ: 既存顧客・新規顧客数 推移</p>
                </div>
                <div class="stat-card">
                    <h4 class="text-lg font-semibold mb-2 text-[#1A535C]">平均客単価 (AOV)</h4>
                    <p class="text-gray-600 mb-4 text-xs">1注文あたりの平均購入金額。商品構成、価格戦略、アップセル/クロスセル施策の効果を反映します。</p>
                    <div class="chart-container h-72 md:h-80">
                        <canvas id="aovChart"></canvas>
                    </div>
                     <p class="mt-2 text-xs text-gray-500 text-center">グラフ: 月次平均客単価推移</p>
                </div>
            </div>
        </section>

        <section id="profitabilityAnalysis" class="mb-12 stat-card">
             <h4 class="text-xl font-semibold mb-2 text-[#1A535C]">収益性分析：純粗利益率トレンド</h4>
             <p class="text-gray-600 mb-6 text-sm">月次の純粗利益率（(売上総利益 - 手数料 - 配送費) / 売上高）の推移です。手数料や配送費を考慮した後の、より実態に近い利益力を示します。</p>
             <div class="chart-container">
                 <canvas id="netGrossProfitMarginChart"></canvas>
             </div>
             <p class="mt-4 text-xs text-gray-500 text-center">グラフ: 月次純粗利益率推移</p>
        </section>

        <section id="adEfficiency" class="mb-12">
            <h3 class="section-title">広告・販促費 効率分析</h3>
            <p class="text-gray-600 mb-6">広告費および販売促進費の売上対比や、ROAS・CPAの推移から、マーケティング投資の効率性と収益性を評価します。</p>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-8"> 
                <div class="stat-card">
                    <h4 class="text-lg font-semibold mb-2 text-[#1A535C]">広告費比率 (売上対比)</h4>
                    <p class="text-gray-600 mb-4 text-xs">売上高に占める広告費の割合。事業の収益構造と広告依存度を示します。</p>
                    <div class="chart-container h-72 md:h-80">
                        <canvas id="adCostRatioChart"></canvas>
                    </div>
                    <p class="mt-2 text-xs text-gray-500 text-center">グラフ: 月次広告費比率推移</p>
                </div>
                <div class="stat-card">
                    <h4 class="text-lg font-semibold mb-2 text-[#1A535C]">販売促進費比率 (売上対比)</h4>
                    <p class="text-gray-600 mb-4 text-xs">売上高に占める総販売促進費の割合。販促活動の効果測定の指標となります。</p>
                    <div class="chart-container h-72 md:h-80">
                        <canvas id="salesPromoCostRatioChart"></canvas>
                    </div>
                    <p class="mt-2 text-xs text-gray-500 text-center">グラフ: 月次販売促進費 売上対比推移</p>
                </div>
                <div class="stat-card">
                    <h4 class="text-lg font-semibold mb-2 text-[#1A535C]">ROAS (広告費用対効果)</h4>
                    <p class="text-gray-600 mb-4 text-xs">投下した広告費に対してどれだけの売上があったかを示します。マーケティングROIの重要な指標です。</p>
                    <div class="chart-container h-72 md:h-80">
                        <canvas id="roasChart"></canvas>
                    </div>
                    <p class="mt-2 text-xs text-gray-500 text-center">グラフ: 月次ROAS推移</p>
                </div>
                <div class="stat-card">
                    <h4 class="text-lg font-semibold mb-2 text-[#1A535C]">CPA (新規顧客獲得単価)</h4>
                    <p class="text-gray-600 mb-4 text-xs">新規顧客を1人獲得するためにかかった広告費用。顧客獲得効率の直接的な指標です。</p>
                    <div class="chart-container h-72 md:h-80">
                        <canvas id="cpaChart"></canvas>
                    </div>
                    <p class="mt-2 text-xs text-gray-500 text-center">グラフ: 月次CPA推移</p>
                </div>
            </div>
        </section>
        
        <section id="insights" class="stat-card">
            <h3 class="section-title">主要インサイトと考察</h3>
            <p class="text-gray-600 mb-6">本事業セグメントのデータ分析から得られた主要な洞察と、それに基づく考察を以下にまとめます。</p>
            <ul class="list-disc list-inside space-y-3 text-gray-700">
                <li><strong class="text-[#FF6B6B]">集客効率の課題顕在化:</strong> 2025年4月において、顧客数が前月比<span class="font-semibold" id="insightCustomersMoM">-13.5%</span>と大幅に減少。同時にCPA（新規顧客獲得単価）が<span class="font-semibold" id="insightCPAMoM">23.9%悪化</span>し3,636円に達しており、新規顧客獲得の効率が著しく低下しています。これが当月の売上減（前月比-11.2%）の主因と考えられます。</li>
                <li><strong class="text-[#4ECDC4]">顧客エンゲージメントと構成の変化:</strong> AOV（平均客単価）は<span class="font-semibold" id="insightAOVValue">4,750円</span>（前月比<span id="insightAOVMoM">+0.6%</span>改善）と底堅さを見せています。新規顧客獲得が鈍化（4月は440人）する一方で、既存顧客が顧客基盤の約67%（893人）を占めており、既存顧客への依存度が高まっている可能性があります。</li>
                <li><strong class="text-purple-600">純粗利益率の動向:</strong> 当月の純粗利益率は<span class="font-semibold" id="insightNetGrossProfitMargin">55.7%</span>であり、前月比<span id="insightNetGrossProfitMarginMoM">+0.7pt改善</span>。手数料・配送費を考慮した実質的な利益率は改善傾向にあり、事業の基礎収益力は維持されています。</li>
                <li><strong class="text-[#1A535C]">広告・販促費とROAS:</strong> 広告費比率は<span class="font-semibold" id="insightAdCostRatio">21.1%</span>（前月比<span id="insightAdCostRatioMoM">+0.3pt悪化</span>）、販売促進費の売上対比は<span class="font-semibold" id="insightSalesPromoCostRatio">7.2%</span>（前月比<span id="insightSalesPromoCostRatioMoM">-0.8pt改善</span>）。ROASは4.74と依然として高い水準ではあるものの、前月から微減（<span id="insightROASMoM">-0.06pt</span>）。CPAの高騰がROASの足かせとなり、収益性を圧迫し始めている兆候が見られます。販促費の効率は若干改善している可能性があります。</li>
                <li><strong class="text-gray-700">季節性と外部要因の考慮:</strong> 過去6ヶ月のデータからは、年末（12月）や年度末（3月）に売上・顧客数のピークが見られる傾向があります。4月の落ち込みには、これらの反動や市場全体の季節的要因も影響している可能性を考慮する必要があります。</li>
                <li><strong class="text-[#45B7D1]">今後の戦略的視点:</strong>
                    <ul class="list-disc list-inside ml-4 mt-1 space-y-1 text-sm">
                        <li>最優先課題として、広告チャネルの最適化、ターゲティング精度の向上、クリエイティブ改善によるCPAの抑制と新規顧客獲得数の回復。</li>
                        <li>強みである既存顧客のエンゲージメントと改善傾向にある純粗利益率を活かし、LTVを最大化するためのCRM施策やリピート購入促進策の強化。</li>
                        <li>広告費・販促費とROAS、CPAのバランスを注視し、利益を最大化する運用モデルの再構築。</li>
                        <li>中長期的には、オーガニック流入増を目指したコンテンツ戦略や、新規集客チャネルの開拓も視野に入れるべきです。</li>
                    </ul>
                </li>
            </ul>
        </section>
         <section id="conclusion" class="mt-12 pt-8 border-t border-[#4ECDC4]">
            <h3 class="text-2xl font-semibold mb-4 text-[#1A535C] text-center">結論とアクションへの提言</h3>
            <p class="text-gray-700 leading-relaxed text-center max-w-3xl mx-auto">
                本Eコマース事業セグメントは、改善傾向にある純粗利益率と既存顧客のエンゲージメントにおいて強みを持つものの、直近では新規顧客獲得の効率性に大きな課題を抱えています。短期的な収益改善のためには広告運用の抜本的な見直しが急務です。中長期的には、既存顧客のLTV最大化と、持続可能な集客モデルの構築が成長の鍵となるでしょう。データに基づき、迅速かつ柔軟な戦略調整を行うことが求められます。
            </p>
        </section>
    </main>

    <footer class="bg-[#1A535C] text-gray-400 py-8 mt-12">
        <div class="container mx-auto px-6 text-center">
            <p>&copy; <span id="currentYear"></span> 特定事業セグメント分析レポート. All rights reserved.</p>
            <p class="text-xs mt-1">このインフォグラフィックは提供されたデータに基づき作成されました。</p>
        </div>
    </footer>

    <script>
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        const labels = ['2024年11月', '2024年12月', '2025年01月', '2025年02月', '2025年03月', '2025年04月'];
        const salesData = [8302029, 9180061, 6968472, 6497245, 8538667, 7585340]; 
        const grossProfitData = [5990933, 6517996, 5136771, 4822270, 6407329, 5745041]; 
        const feesData = [766924.7544, 893287.4091, 671801.2917, 633440.0187, 816472.7181, 737421.7137]; 
        const shippingCostsData = [847292.3772, 946055.0338, 716868.2346, 669821.0914, 877043.0734, 781571.3234]; 
        const customersData = [1790, 1887, 1408, 1294, 1541, 1333]; 
        const existingCustomersData = [686, 953, 752, 674, 935, 893];
        const newCustomersData = [1104, 934, 656, 620, 606, 440];
        const ordersData = [2025, 2327, 1654, 1523, 1808, 1597];
        const adCostData = [5659183, 4032460, 2137580, 1607490, 1779128, 1599998];
        const promoCostInternalData = [758438, 749373, 571460, 437246, 683788, 545286];
        const promoCostExternalData = [3346999.091, 826650, 423143.6364, 185400, 0, 0];
        const roasData = [1.47, 2.28, 3.26, 4.04, 4.80, 4.74];
        const cpaData = [5126, 4317, 3259, 2593, 2936, 3636];
        
        const aovData = salesData.map((sale, index) => ordersData[index] > 0 ? (sale / ordersData[index]) : 0);
        const adCostRatioData = salesData.map((sale, index) => sale > 0 ? (adCostData[index] / sale * 100) : 0);
        const netGrossProfitMarginData = salesData.map((sale, index) => {
            if (sale > 0) {
                const netGrossProfit = grossProfitData[index] - feesData[index] - shippingCostsData[index];
                return (netGrossProfit / sale * 100);
            }
            return 0;
        });
        const salesPromoCostRatioData = salesData.map((sale, index) => {
            if (sale > 0) {
                const totalPromoCost = promoCostInternalData[index] + promoCostExternalData[index];
                return (totalPromoCost / sale * 100);
            }
            return 0;
        });

        const latestIndex = labels.length - 1;
        const prevIndex = labels.length - 2;

        function calculateMoM(current, previous) {
            if (previous === 0 || previous === null || previous === undefined) return { value: null, text: 'N/A' };
            const change = ((current - previous) / previous) * 100;
            const sign = change >= 0 ? '+' : ''; 
            return { value: change, text: `${sign}${change.toFixed(1)}%` };
        }
        
        function calculateMoMPoints(current, previous, decimals = 1, unit = 'pt') { 
            if (previous === null || previous === undefined) return { value: null, text: 'N/A' };
            const change = current - previous;
            const sign = change >= 0 ? '+' : '';
            return { value: change, text: `${sign}${change.toFixed(decimals)}${unit}`};
        }

        const salesMoM = calculateMoM(salesData[latestIndex], salesData[prevIndex]);
        const customersMoM = calculateMoM(customersData[latestIndex], customersData[prevIndex]);
        const netGrossProfitMarginMoM = calculateMoMPoints(netGrossProfitMarginData[latestIndex], netGrossProfitMarginData[prevIndex], 1, 'pt');
        const adCostRatioMoM = calculateMoMPoints(adCostRatioData[latestIndex], adCostRatioData[prevIndex], 1, 'pt'); 
        const salesPromoCostRatioMoM = calculateMoMPoints(salesPromoCostRatioData[latestIndex], salesPromoCostRatioData[prevIndex], 1, 'pt');
        const roasMoM = calculateMoMPoints(roasData[latestIndex], roasData[prevIndex], 2, ''); 
        const cpaMoM = calculateMoM(cpaData[latestIndex], cpaData[prevIndex]); 
        const aovMoM = calculateMoM(aovData[latestIndex], aovData[prevIndex]);

        document.getElementById('latestSales').innerHTML = `${(salesData[latestIndex]/10000).toFixed(1)}<span class="text-base">万円</span>`;
        document.getElementById('salesMoMChange').textContent = `前月比: ${salesMoM.text}`;
        document.getElementById('salesMoMChange').className = `kpi-change ${salesMoM.value > 0 ? 'positive-change' : salesMoM.value < 0 ? 'negative-change' : 'text-gray-500'}`;

        document.getElementById('latestCustomers').innerHTML = `${customersData[latestIndex].toLocaleString()}<span class="text-base">人</span>`;
        document.getElementById('customersMoMChange').textContent = `前月比: ${customersMoM.text}`;
        document.getElementById('customersMoMChange').className = `kpi-change ${customersMoM.value > 0 ? 'positive-change' : customersMoM.value < 0 ? 'negative-change' : 'text-gray-500'}`;
        
        document.getElementById('latestNetGrossProfitMargin').innerHTML = `${netGrossProfitMarginData[latestIndex].toFixed(1)}<span class="text-base">%</span>`;
        document.getElementById('netGrossProfitMarginMoMChange').textContent = `前月比: ${netGrossProfitMarginMoM.text}`;
        document.getElementById('netGrossProfitMarginMoMChange').className = `kpi-change ${netGrossProfitMarginMoM.value >= 0 ? 'positive-change' : 'negative-change'}`;


        document.getElementById('latestAdCostRatio').innerHTML = `${adCostRatioData[latestIndex].toFixed(1)}<span class="text-base">%</span>`;
        document.getElementById('adCostRatioMoMChange').textContent = `前月比: ${adCostRatioMoM.text}`;
        document.getElementById('adCostRatioMoMChange').className = `kpi-change ${adCostRatioMoM.value > 0 ? 'negative-change' : adCostRatioMoM.value < 0 ? 'positive-change' : 'text-gray-500'}`;

        document.getElementById('latestROAS').textContent = roasData[latestIndex].toFixed(2);
        document.getElementById('roasMoMChange').textContent = `前月比: ${roasMoM.text}`;
        document.getElementById('roasMoMChange').className = `kpi-change ${roasMoM.value > 0 ? 'positive-change' : roasMoM.value < 0 ? 'negative-change' : 'text-gray-500'}`;

        document.getElementById('latestCPA').innerHTML = `${cpaData[latestIndex].toLocaleString()}<span class="text-base">円</span>`;
        document.getElementById('cpaMoMChange').textContent = `前月比: ${cpaMoM.text}`;
        document.getElementById('cpaMoMChange').className = `kpi-change ${cpaMoM.value > 0 ? 'negative-change' : cpaMoM.value < 0 ? 'positive-change' : 'text-gray-500'}`; 

        document.getElementById('insightCustomersMoM').textContent = customersMoM.text;
        document.getElementById('insightCPAMoM').textContent = `${cpaMoM.text}${cpaMoM.value > 0 ? '悪化' : cpaMoM.value < 0 ? '改善' : ''}`;
        
        const insightAOVValueElement = document.getElementById('insightAOVValue');
        if(insightAOVValueElement) insightAOVValueElement.textContent = aovData[latestIndex].toFixed(0) + "円";
        
        document.getElementById('insightAOVMoM').textContent = aovMoM.text;
        document.getElementById('insightROASMoM').textContent = roasMoM.text;
        document.getElementById('insightAdCostRatio').textContent = `${adCostRatioData[latestIndex].toFixed(1)}%`;
        document.getElementById('insightAdCostRatioMoM').textContent = `${adCostRatioMoM.text}${adCostRatioMoM.value > 0 ? '悪化' : adCostRatioMoM.value < 0 ? '改善' : ''}`;
        
        document.getElementById('insightNetGrossProfitMargin').textContent = `${netGrossProfitMarginData[latestIndex].toFixed(1)}%`;
        document.getElementById('insightNetGrossProfitMarginMoM').textContent = `${netGrossProfitMarginMoM.text}${netGrossProfitMarginMoM.value >= 0 ? '改善' : '悪化'}`;

        const insightSalesPromoCostRatioElement = document.getElementById('insightSalesPromoCostRatio');
        if(insightSalesPromoCostRatioElement) insightSalesPromoCostRatioElement.textContent = `${salesPromoCostRatioData[latestIndex].toFixed(1)}%`;
        const insightSalesPromoCostRatioMoMElement = document.getElementById('insightSalesPromoCostRatioMoM');
        if(insightSalesPromoCostRatioMoMElement) insightSalesPromoCostRatioMoMElement.textContent = `${salesPromoCostRatioMoM.text}${salesPromoCostRatioMoM.value > 0 ? '悪化' : salesPromoCostRatioMoM.value < 0 ? '改善' : ''}`;


        const insightCustomerEngagementElement = document.querySelector('#insights ul li:nth-child(2) strong.text-\\[\\#4ECDC4\\]').parentNode;
        if (insightCustomerEngagementElement) {
            insightCustomerEngagementElement.innerHTML = `<strong class="text-[#4ECDC4]">顧客エンゲージメントと構成の変化:</strong> AOV（平均客単価）は<span class="font-semibold" id="insightAOVValueText">${aovData[latestIndex].toFixed(0)}円</span>（前月比<span id="insightAOVMoMText">${aovMoM.text}</span>）と底堅さを見せています。新規顧客獲得が鈍化（4月は${newCustomersData[latestIndex]}人）する一方で、既存顧客が顧客基盤の約${((existingCustomersData[latestIndex]/customersData[latestIndex])*100).toFixed(0)}%（${existingCustomersData[latestIndex]}人）を占めており、既存顧客への依存度が高まっている可能性があります。`;
            const insightAOVMoMTextElement = document.getElementById('insightAOVMoMText');
            if (insightAOVMoMTextElement) insightAOVMoMTextElement.textContent = aovMoM.text;
        }


        function formatLabel(str, maxLength) {
            if (!str || typeof str.length === 'undefined' || str.length <= maxLength) return str;
            const words = str.split(" ");
            const lines = [];
            let currentLine = "";
            for (const word of words) {
                if ((currentLine + (currentLine ? " " : "") + word).length > maxLength && currentLine) {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine += (currentLine ? " " : "") + word;
                }
            }
            if (currentLine) lines.push(currentLine);
            return lines.length > 0 ? lines : [str]; 
        }
        
        const defaultChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { 
                        color: '#1A535C',
                        font: { family: "'Inter', 'Noto Sans JP', sans-serif" }
                    },
                    grid: { color: 'rgba(78, 205, 196, 0.2)' } 
                },
                x: {
                    ticks: { 
                        color: '#1A535C',
                        font: { family: "'Inter', 'Noto Sans JP', sans-serif" },
                        callback: function(value, index, ticks) {
                            const label = this.getLabelForValue(value);
                            return formatLabel(label, 16); 
                        }
                    },
                    grid: { display: false }
                }
            },
            plugins: {
                legend: {
                    labels: { 
                        color: '#1A535C',
                        font: { family: "'Inter', 'Noto Sans JP', sans-serif" }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(26, 83, 92, 0.9)', 
                    titleFont: { family: "'Inter', 'Noto Sans JP', sans-serif", weight: 'bold', size: 14 },
                    bodyFont: { family: "'Inter', 'Noto Sans JP', sans-serif", size: 12 },
                    callbacks: {
                        title: function(tooltipItems) {
                            const item = tooltipItems[0];
                            let label = item.chart.data.labels[item.dataIndex];
                            if (Array.isArray(label)) { 
                                return label.join(' '); 
                            } else if (typeof label === 'string' && label.includes('\n')) { 
                                return label.replace(/\n/g, ' ');
                            }
                            return label; 
                        },
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                const yAxisID = context.dataset.yAxisID || 'y'; 
                                if (yAxisID === 'yPercentage') {
                                     label += context.parsed.y.toFixed(1) + '%';
                                } else if (yAxisID === 'yRatio') {
                                     label += context.parsed.y.toFixed(2);
                                } else if (yAxisID === 'yCurrency') {
                                     label += '¥' + Math.round(context.parsed.y).toLocaleString();
                                } else {
                                     label += Math.round(context.parsed.y).toLocaleString();
                                }
                            }
                            return label;
                        }
                    }
                }
            }
        };
        
        const wrappedLabels = labels.map(label => formatLabel(label, 16));

        new Chart(document.getElementById('salesChart'), {
            type: 'line',
            data: {
                labels: wrappedLabels,
                datasets: [{
                    label: '売上高（税抜）',
                    data: salesData,
                    borderColor: '#FF6B6B', 
                    backgroundColor: 'rgba(255, 107, 107, 0.2)',
                    tension: 0.1,
                    fill: true,
                    yAxisID: 'yCurrency'
                }]
            },
            options: defaultChartOptions
        });

        new Chart(document.getElementById('customersChart'), {
            type: 'line', 
            data: {
                labels: wrappedLabels,
                datasets: [{
                    label: '顧客数',
                    data: customersData,
                    borderColor: '#4ECDC4', 
                    backgroundColor: 'rgba(78, 205, 196, 0.2)', 
                    tension: 0.1,
                    fill: true 
                }]
            },
            options: defaultChartOptions 
        });

        new Chart(document.getElementById('ordersChart'), {
            type: 'line', 
            data: {
                labels: wrappedLabels,
                datasets: [{
                    label: '注文件数',
                    data: ordersData,
                    borderColor: '#45B7D1', 
                    backgroundColor: 'rgba(69, 183, 209, 0.2)', 
                    tension: 0.1,
                    fill: true 
                }]
            },
            options: defaultChartOptions 
        });
        
        new Chart(document.getElementById('customerCompositionChart'), { 
            type: 'line',
            data: {
                labels: wrappedLabels,
                datasets: [
                    {
                        label: '既存顧客数',
                        data: existingCustomersData,
                        borderColor: '#4ECDC4', 
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        tension: 0.1,
                        fill: false
                    },
                    {
                        label: '新規顧客数',
                        data: newCustomersData,
                        borderColor: '#45B7D1', 
                        backgroundColor: 'rgba(69, 183, 209, 0.1)',
                        tension: 0.1,
                        fill: false
                    }
                ]
            },
            options: defaultChartOptions
        });

        new Chart(document.getElementById('aovChart'), {
            type: 'line',
            data: {
                labels: wrappedLabels,
                datasets: [{
                    label: '平均客単価 (円)',
                    data: aovData,
                    borderColor: '#FF6B6B', 
                    backgroundColor: 'rgba(255, 107, 107, 0.1)',
                    tension: 0.1,
                    yAxisID: 'yCurrency'
                }]
            },
            options: defaultChartOptions
        });
        
        new Chart(document.getElementById('netGrossProfitMarginChart'), { 
            type: 'line',
            data: {
                labels: wrappedLabels,
                datasets: [{
                    label: '純粗利益率 (%)',
                    data: netGrossProfitMarginData,
                    borderColor: '#8E44AD', 
                    backgroundColor: 'rgba(142, 68, 173, 0.1)',
                    tension: 0.1,
                    fill: true,
                    yAxisID: 'yPercentage'
                }]
            },
            options: defaultChartOptions
        });


        new Chart(document.getElementById('adCostRatioChart'), {
            type: 'line',
            data: {
                labels: wrappedLabels,
                datasets: [{
                    label: '広告費比率 (%)',
                    data: adCostRatioData,
                    borderColor: '#FFC107', 
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    tension: 0.1,
                    yAxisID: 'yPercentage'
                }]
            },
            options: defaultChartOptions
        });
        
        new Chart(document.getElementById('salesPromoCostRatioChart'), { 
            type: 'line',
            data: {
                labels: wrappedLabels,
                datasets: [{
                    label: '販売促進費 売上対比 (%)',
                    data: salesPromoCostRatioData,
                    borderColor: '#5cb85c', 
                    backgroundColor: 'rgba(92, 184, 92, 0.1)',
                    tension: 0.1,
                    fill: true,
                    yAxisID: 'yPercentage'
                }]
            },
            options: defaultChartOptions
        });


        new Chart(document.getElementById('roasChart'), {
            type: 'line',
            data: {
                labels: wrappedLabels,
                datasets: [{
                    label: 'ROAS',
                    data: roasData,
                    borderColor: '#45B7D1', 
                    backgroundColor: 'rgba(69, 183, 209, 0.1)',
                    tension: 0.1,
                    yAxisID: 'yRatio'
                }]
            },
            options: defaultChartOptions
        });

        new Chart(document.getElementById('cpaChart'), {
            type: 'line',
            data: {
                labels: wrappedLabels,
                datasets: [{
                    label: 'CPA (円)',
                    data: cpaData,
                    borderColor: '#FF6B6B', 
                    backgroundColor: 'rgba(255, 107, 107, 0.1)',
                    tension: 0.1,
                    yAxisID: 'yCurrency' 
                }]
            },
            options: defaultChartOptions
        });
    </script>
</body>
</html>
